version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸ”§ Using Amplify default Node.js version (20.19.0)"
        - node --version
        - npm --version
        - export NEXT_TELEMETRY_DISABLED=1
        - export GENERATE_SOURCEMAP=false
        - export NODE_OPTIONS="--max-old-space-size=8192"
        - echo "ðŸ“¦ Installing dependencies using npm ci"
        - npm ci
    build:
      commands:
        - echo "ðŸ— Running Next.js production build with standalone output"
        - npm run build
        # CRITICAL FIX 1: Copy required-server-files.json to standalone root
        - echo "ðŸ“‹ Copying required-server-files.json to standalone root"
        - cp .next/standalone/.next/required-server-files.json .next/standalone/required-server-files.json
        # CRITICAL FIX 2: Copy trace files to ALL possible locations
        - echo "ðŸ“‹ Creating all trace file locations for Amplify compatibility"
        - cp .next/trace .next/standalone/trace
        - mkdir -p .next/standalone/.next
        - cp .next/trace .next/standalone/.next/trace
        - mkdir -p .next/standalone/.next/server
        - cp .next/trace .next/standalone/.next/server/trace
        - mkdir -p .next/standalone/server
        - cp .next/trace .next/standalone/server/trace
        # Ensure server directory exists at baseDirectory root (some Amplify checks expect this)
        - echo "ðŸ“ Ensuring server directory is available at baseDirectory root"
        - rm -rf .next/standalone/server || true
        - cp -r .next/standalone/.next/server .next/standalone/server
        - echo "âœ… Copied .next/server -> server"
        - echo "âœ… All trace files created in multiple locations"
        - echo "ðŸŽ‰ ALL FILES READY FOR AMPLIFY DEPLOYMENT!"
  artifacts:
    baseDirectory: .next/standalone
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.npm