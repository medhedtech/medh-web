version: 1
frontend:
  phases:
    preBuild:
      commands:
        - "echo '=== Starting Amplify Build ==='"
        - "nvm install 22.16.0"
        - "nvm use 22.16.0"
        - "echo 'Node version: $(node -v)'"
        - "echo 'NPM version: $(npm -v)'"
        # Environment variables
        - "export NEXT_PUBLIC_API_URL=\"https://api.medh.co/api/v1\""
        - "export NEXT_PUBLIC_APP_ENV=\"production\""
        - "export JWT_SECRET=\"${JWT_SECRET:-fallback-jwt-secret}\""
        - "export API_KEY_SALT=\"${API_KEY_SALT:-fallback-salt}\""
        - "export SESSION_SECRET=\"${SESSION_SECRET:-fallback-session-secret}\""
        - "export MONGO_URI=\"${MONGO_URI}\""
        - "export NODE_OPTIONS='--max-old-space-size=8192'"
        - "export NEXT_TELEMETRY_DISABLED=1"
        - "export GENERATE_SOURCEMAP=false"
        - "rm -rf node_modules .next"
        - "npm ci --legacy-peer-deps"
    build:
      commands:
        - "echo 'üèó Running Next.js production build (standalone output)'"
        - "npm run build"
        - "echo '‚úÖ Build completed'"
  artifacts:
    baseDirectory: .next/standalone
    files:
      - "**/*"
  cache:
    paths:
      - "node_modules//*"
appRoot: .