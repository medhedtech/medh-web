version: 1
frontend:
  phases:
    preBuild:
      commands:
        - node --version
        - npm --version
        - export NEXT_TELEMETRY_DISABLED=1
        - export GENERATE_SOURCEMAP=false
        - export NODE_OPTIONS="--max-old-space-size=8192"
        - npm ci
    build:
      commands:
        - npm run build

        # Ensure traces exist in both legacy and new locations
        - mkdir -p .next/server
        - if [ -f ".next/server/trace" ]; then echo "server/trace exists"; elif [ -f ".next/trace" ]; then cp -f .next/trace .next/server/trace; else echo "{}" > .next/trace && cp -f .next/trace .next/server/trace; fi

        # Ensure required-server-files.json is present
        - if [ -f ".next/required-server-files.json" ]; then echo "required-server-files.json present"; else echo "{}" > .next/required-server-files.json; fi

        # Sanity check
        - ls -la .next | cat
        - ls -la .next/server | cat
        - test -f .next/trace || (echo "missing .next/trace" && exit 1)
        - test -f .next/server/trace || (echo "missing .next/server/trace" && exit 1)
        - test -f .next/required-server-files.json || (echo "missing required-server-files.json" && exit 1)

  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.npm
