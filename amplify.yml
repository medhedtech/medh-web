version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "üîß Using Amplify default Node.js version (20.19.0)"
        - node --version
        - npm --version
        - export NEXT_TELEMETRY_DISABLED=1
        - export GENERATE_SOURCEMAP=false
        - export NODE_OPTIONS="--max-old-space-size=8192"
        - echo "üì¶ Installing dependencies using npm ci"
        - npm ci
    build:
      commands:
        - echo "üèó Running Next.js production build with standalone output"
        - npm run build

        # Ensure required files are inside .next/standalone/.next (the new baseDirectory)
        - echo "üìã Ensuring required server files exist under .next/standalone/.next"
        - mkdir -p .next/standalone/.next/server
        - if [ -f ".next/server/trace" ]; then cp -f .next/server/trace .next/standalone/.next/server/trace; elif [ -f ".next/trace" ]; then cp -f .next/trace .next/standalone/.next/server/trace; else echo "‚ö†Ô∏è No trace file found in .next"; fi
        - if [ -f ".next/required-server-files.json" ]; then cp -f .next/required-server-files.json .next/standalone/.next/required-server-files.json; fi
        - mkdir -p .next/standalone/.next/static
        - cp -r .next/static/* .next/standalone/.next/static/ 2>/dev/null || true

        # Optional: size pruning (safe to keep, but not required for Amplify)
        - rm -rf .next/standalone/src || true
        - find .next/standalone -type f -name "*.map" -delete || true
        - find .next/standalone/node_modules -type d -name "__tests__" -prune -exec rm -rf {} + || true
        - find .next/standalone/node_modules -type d -name "test" -prune -exec rm -rf {} + || true

        # Sanity check to fail fast if traces missing
        - echo "üîé Validating trace presence"
        - test -f .next/standalone/.next/server/trace || (echo "‚ùå Missing server trace under new baseDirectory" && exit 1)

        - echo "‚úÖ Build artifacts ready for Amplify"
        - du -sh .next/standalone/.next || true
  artifacts:
    baseDirectory: .next/standalone/.next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.npm
