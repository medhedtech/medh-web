version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "=== AWS Amplify Build Configuration ==="
        - echo "Available Node.js$(node -v)"
        - echo "Available npm$(npm -v)"
        - echo "Target Node.js$(cat .nvmrc 2>/dev/null || echo 'Not specified')"
        - echo "AWS Branch $AWS_BRANCH"
        - echo "Build ID $AWS_BUILD_ID"
        - echo ""
        
        # BYPASS SSM ISSUES - Set environment variables directly
        - |
          echo "=== Setting Environment Variables (Bypassing SSM) ==="
          export NODE_ENV="production"
          export NEXT_PUBLIC_API_URL="https://api.medh.co/api/v1"
          export NEXT_PUBLIC_APP_ENV="production"
          
          # Set fallback values for missing critical variables
          export JWT_SECRET="${JWT_SECRET:-fallback-jwt-secret-for-build-only-not-secure}"
          export API_KEY_SALT="${API_KEY_SALT:-fallback-salt}"
          export SESSION_SECRET="${SESSION_SECRET:-fallback-session-secret}"
          
          # AGGRESSIVE MEMORY CONFIGURATION FOR BUILD
          export NEXT_TIMEOUT=3600000  # 60 minutes
          export NEXT_STATIC_EXPORT_TIMEOUT=3600000  # 60 minutes
          # Increase memory to 24GB and optimize garbage collection
          export NODE_OPTIONS="--max-old-space-size=24576 --max-semi-space-size=2048 --no-warnings --optimize-for-size --gc-interval=100"
          export AMPLIFY_DISABLE_TIMEOUT=true
          export AMPLIFY_BUILD_TIMEOUT=7200  # 2 hours
          
          # Memory optimization flags
          export UV_THREADPOOL_SIZE=16
          export NODE_MAX_OLD_SPACE_SIZE=24576
          export GENERATE_SOURCEMAP=false
          export DISABLE_ESLINT_PLUGIN=true
          export TSC_COMPILE_ON_ERROR=true
          export SKIP_PREFLIGHT_CHECK=true
          
          # TypeScript configuration for Next.js
          export NEXT_TELEMETRY_DISABLED=1
          export TSC_COMPILE_ON_ERROR=true
          export SKIP_TYPE_CHECK=false
          
          # Log what we're using (without showing actual secrets)
          echo "NODE_ENV: $NODE_ENV"
          echo "NEXT_PUBLIC_API_URL: $NEXT_PUBLIC_API_URL"
          echo "JWT_SECRET: ${JWT_SECRET:0:10}... (length: ${#JWT_SECRET})"
          echo "Memory allocated: 24GB"
          echo "Build timeout: 2 hours"
          
          # Create .env file for build
          cat > .env << EOF
          NODE_ENV=production
          NEXT_PUBLIC_API_URL=https://api.medh.co/api/v1
          NEXT_PUBLIC_APP_ENV=production
          JWT_SECRET=$JWT_SECRET
          API_KEY_SALT=$API_KEY_SALT
          SESSION_SECRET=$SESSION_SECRET
          GENERATE_SOURCEMAP=false
          DISABLE_ESLINT_PLUGIN=true
          EOF
          
          echo "✅ Environment variables set and .env file created"
        
        # Flexible Node.js version handling
        - |
          CURRENT_MAJOR=$(node -v | sed 's/v//' | cut -d. -f1)
          echo "Current Node.js major version v$CURRENT_MAJOR"
          
          # Check minimum compatibility (Node.js 18+)
          if [ "$CURRENT_MAJOR" -ge "18" ]; then
            echo "✅ Node.js version is compatible for Next.js (v$CURRENT_MAJOR >= v18)"
          else
            echo "❌ Node.js version too old (v$CURRENT_MAJOR < v18)"
            echo "This project requires Node.js 18 or higher"
            exit 1
          fi
          
          # Try to use specific version if possible
          if [ -f .nvmrc ] && command -v nvm >/dev/null 2>&1; then
            REQUIRED_VERSION=$(cat .nvmrc)
            echo ""
            echo "Attempting to use Node.js v$REQUIRED_VERSION via nvm..."
            nvm install $REQUIRED_VERSION && nvm use $REQUIRED_VERSION || {
              echo "⚠️  Failed to switch to v$REQUIRED_VERSION, continuing with v$CURRENT_MAJOR"
            }
          fi
        
        - echo ""
        - echo "Final environment"
        - "echo \"Node.js $(node -v)\""
        - "echo \"npm $(npm -v)\""
        
        # Install pnpm globally with memory optimization
        - echo ""
        - echo "=== Installing pnpm ==="
        - NODE_OPTIONS="--max-old-space-size=4096" npm install -g pnpm@latest
        - "echo \"pnpm $(pnpm -v)\""
        
        - echo "Configuring npm and pnpm for memory optimization..."
        - npm config set legacy-peer-deps true
        - npm config set audit-level moderate
        - npm config set fund false
        - npm config set update-notifier false
        - npm config set progress false
        - pnpm config set store-dir ~/.pnpm-store
        - pnpm config set verify-store-integrity false
        - pnpm config set package-import-method hardlink
        
        # Memory-optimized dependency cleanup and installation
        - echo ""
        - echo "=== Memory-Optimized Dependency Installation ==="
        - echo "Cleaning up potential dependency conflicts..."
        - rm -rf node_modules/.staging 2>/dev/null || true
        - rm -rf node_modules/.cache 2>/dev/null || true
        - rm -rf node_modules/@radix-ui 2>/dev/null || true
        - rm -rf .next/cache 2>/dev/null || true
        - rm -rf ~/.npm/_cacache 2>/dev/null || true
        
        # Debug package.json and pnpm-lock.yaml
        - echo "Checking package.json..."
        - ls -la package.json
        - echo "Checking pnpm-lock.yaml..."
        - ls -la pnpm-lock.yaml || echo "⚠️ No pnpm-lock.yaml found"
        - echo "Node modules before install:"
        - ls -la node_modules/ 2>/dev/null || echo "No node_modules directory"
        
        # Ensure exact versions for problematic packages
        - echo "Ensuring exact versions for Radix UI packages..."
        - |
          # Backup original package.json
          cp package.json package.json.bak
          
          # Add exact versions for Radix UI packages
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.dependencies['@radix-ui/react-avatar'] = '1.1.10';
            pkg.dependencies['@radix-ui/react-progress'] = '1.1.7';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          
          echo "Updated package.json with exact versions"
        
        # Memory-optimized clean install with chunked installation
        - echo ""
        - echo "Installing dependencies with memory optimization..."
        - |
          # Set memory limits for pnpm
          export NODE_OPTIONS="--max-old-space-size=8192 --max-semi-space-size=1024"
          
          # Use pnpm for dependency installation with memory optimization
          if [ -f pnpm-lock.yaml ]; then
            echo "Using pnpm install with frozen lockfile and memory optimization..."
            pnpm install --frozen-lockfile --prefer-offline --reporter=silent || {
              echo "pnpm frozen install failed, falling back to regular pnpm install..."
              rm -rf node_modules
              pnpm install --prefer-offline --reporter=silent
            }
          else
            echo "No pnpm-lock.yaml found, using pnpm install..."
            pnpm install --prefer-offline --reporter=silent
          fi
          
          # Install critical dependencies in chunks to manage memory
          echo "Installing critical UI dependencies in chunks..."
          pnpm add @radix-ui/react-avatar @radix-ui/react-progress @radix-ui/react-checkbox @radix-ui/react-label --prefer-offline --reporter=silent
          
          echo "Installing remaining Radix UI dependencies..."
          pnpm add @radix-ui/react-roving-focus @radix-ui/react-select @radix-ui/react-separator @radix-ui/react-slot @radix-ui/react-switch @radix-ui/react-tabs --prefer-offline --reporter=silent
          
          # Force reinstall of problematic packages
          echo "Force reinstalling problematic packages..."
          pnpm add --force @radix-ui/react-avatar @radix-ui/react-progress --reporter=silent
          
          # Clear pnpm store and reinstall if still failing
          echo "Clearing pnpm store and double-checking installation..."
          pnpm store prune
          pnpm add @radix-ui/react-avatar @radix-ui/react-progress --reporter=silent
          
          # Explicitly install TypeScript and related dependencies
          echo "Ensuring TypeScript and build dependencies are installed..."
          pnpm add typescript @types/react @types/react-dom @types/node tsx --prefer-offline --reporter=silent
          
          # Verify TypeScript installation immediately
          echo "Verifying TypeScript installation..."
          if [ -f "node_modules/.bin/tsc" ]; then
            echo "✅ TypeScript compiler installed successfully"
            node_modules/.bin/tsc --version
          else
            echo "❌ TypeScript installation failed - trying global install"
            NODE_OPTIONS="--max-old-space-size=4096" npm install -g typescript
          fi
        
        # Verify installation
        - echo ""
        - echo "=== Post-Install Verification ==="
        - echo "Node modules after install:"
        - ls -la node_modules/ | head -10
        - echo "Checking critical dependencies..."
        - pnpm list next react react-dom --depth=0 || echo "⚠️ Some critical dependencies missing"
        - echo "Checking Radix UI dependencies..."
        - |
          # Detailed verification of Radix UI packages
          echo "Verifying @radix-ui/react-avatar installation..."
          if [ -d "node_modules/@radix-ui/react-avatar" ]; then
            echo "✅ @radix-ui/react-avatar is installed"
            ls -la node_modules/@radix-ui/react-avatar/
          else
            echo "❌ @radix-ui/react-avatar is NOT installed"
            echo "Attempting emergency install..."
            NODE_OPTIONS="--max-old-space-size=4096" pnpm add @radix-ui/react-avatar --force --reporter=silent
          fi
          
          echo "Verifying @radix-ui/react-progress installation..."
          if [ -d "node_modules/@radix-ui/react-progress" ]; then
            echo "✅ @radix-ui/react-progress is installed"
            ls -la node_modules/@radix-ui/react-progress/
          else
            echo "❌ @radix-ui/react-progress is NOT installed"
            echo "Attempting emergency install..."
            NODE_OPTIONS="--max-old-space-size=4096" pnpm add @radix-ui/react-progress --force --reporter=silent
          fi
          
          # Final verification with pnpm list
           pnpm list @radix-ui/react-avatar @radix-ui/react-progress --depth=0 || {
             echo "❌ Final verification failed - attempting manual installation"
             
             # Manual installation as last resort
             mkdir -p node_modules/@radix-ui
             
             # Download and install avatar package manually
             if [ ! -d "node_modules/@radix-ui/react-avatar" ]; then
               echo "Manually downloading @radix-ui/react-avatar..."
               curl -L "https://registry.npmjs.org/@radix-ui/react-avatar/-/react-avatar-1.1.10.tgz" -o avatar.tgz
               mkdir -p node_modules/@radix-ui/react-avatar
               tar -xzf avatar.tgz -C node_modules/@radix-ui/react-avatar --strip-components=1
               rm avatar.tgz
             fi
             
             # Download and install progress package manually
             if [ ! -d "node_modules/@radix-ui/react-progress" ]; then
               echo "Manually downloading @radix-ui/react-progress..."
               curl -L "https://registry.npmjs.org/@radix-ui/react-progress/-/react-progress-1.1.7.tgz" -o progress.tgz
               mkdir -p node_modules/@radix-ui/react-progress
               tar -xzf progress.tgz -C node_modules/@radix-ui/react-progress --strip-components=1
               rm progress.tgz
             fi
             
             echo "✅ Manual installation completed"
           }
           
           # Comprehensive TypeScript verification
           echo "Final TypeScript verification..."
           if [ -f "node_modules/.bin/tsc" ] && [ -f "node_modules/typescript/package.json" ]; then
             echo "✅ TypeScript compiler found"
             node_modules/.bin/tsc --version
             
             # Test TypeScript compilation
             echo "Testing TypeScript compilation..."
             echo 'console.log("TypeScript test");' > test.ts
             if node_modules/.bin/tsc test.ts --noEmit 2>/dev/null; then
               echo "✅ TypeScript compilation test passed"
             else
               echo "⚠️ TypeScript compilation test failed but continuing..."
             fi
             rm -f test.ts test.js 2>/dev/null || true
           else
             echo "❌ TypeScript compiler not found - attempting emergency install"
             NODE_OPTIONS="--max-old-space-size=4096" npm install typescript @types/react @types/react-dom @types/node --force --no-cache
             
             # If still failing, try global install
             if [ ! -f "node_modules/.bin/tsc" ]; then
               echo "❌ Local install failed - trying global TypeScript"
               NODE_OPTIONS="--max-old-space-size=4096" npm install -g typescript
               export PATH="$PATH:$(npm config get prefix)/bin"
             fi
           fi
           
           # Final TypeScript types verification
           echo "Verifying TypeScript types..."
           pnpm list typescript @types/react @types/react-dom @types/node --depth=0 || {
             echo "❌ TypeScript types verification failed - attempting final reinstall"
             NODE_OPTIONS="--max-old-space-size=4096" pnpm add typescript @types/react @types/react-dom @types/node tsx --force --reporter=silent
           }
           
           # Set PATH for build phase
           echo "Setting TypeScript PATH for build..."
           export PATH="$PWD/node_modules/.bin:$PATH"
    build:
      commands:
        - echo ""
        - echo "=== Starting Memory-Optimized Build Process ==="
        - echo "Setting up TypeScript environment for build..."
        - export PATH="$PWD/node_modules/.bin:$PATH"
        - export NEXT_TELEMETRY_DISABLED=1
        - export TSC_COMPILE_ON_ERROR=true
        - export GENERATE_SOURCEMAP=false
        - export DISABLE_ESLINT_PLUGIN=true
        - |
          # Final pre-build TypeScript check
          if [ -f "node_modules/.bin/tsc" ]; then
            echo "✅ TypeScript available for build: $(node_modules/.bin/tsc --version)"
          else
            echo "❌ TypeScript not found - emergency install"
            NODE_OPTIONS="--max-old-space-size=4096" pnpm add typescript --force --reporter=silent
          fi
        - chmod +x ./scripts/amplify-build.sh
        - ./scripts/amplify-build.sh
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.pnpm-store/**/*
appRoot: .