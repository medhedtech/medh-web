version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Basic environment info
        - echo "=== Starting Amplify Build ==="
        - echo "Node.js version: $(node -v)"
        - echo "npm version: $(npm -v)"
        
        # Set essential environment variables
        - |
          export NODE_ENV="production"
          export NEXT_PUBLIC_API_URL="https://api.medh.co/api/v1"
          export NEXT_PUBLIC_APP_ENV="production"
          export JWT_SECRET="${JWT_SECRET:-fallback-jwt-secret-for-build}"
          export API_KEY_SALT="${API_KEY_SALT:-fallback-salt}"
          export SESSION_SECRET="${SESSION_SECRET:-fallback-session-secret}"
          export NODE_OPTIONS="--max-old-space-size=8192"
          export NEXT_TELEMETRY_DISABLED=1
        
        # Configure npm for faster, more reliable installs
        - npm config set legacy-peer-deps true
        - npm config set fund false
        - npm config set audit false
        - npm config set update-notifier false
        
        # Clean install dependencies
        - echo "Installing dependencies..."
        - rm -rf node_modules
        - npm ci || npm install
        
        # Ensure critical build dependencies are installed
        - echo "Ensuring critical dependencies..."
        - npm install autoprefixer postcss tailwindcss
        
    build:
      commands:
        - echo "Building Next.js application..."
        - npm run build
        
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

appRoot: .
