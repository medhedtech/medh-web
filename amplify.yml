version: 1
frontend:
  phases:
    preBuild:
      commands:
        - "echo '=== Starting Amplify Build with automatic cache clear ==='"
        - "nvm install 22.16.0"
        - "nvm use 22.16.0"
        - "echo 'Node version: $(node -v)'"
        - "echo 'NPM version: $(npm -v)'"
        # Environment variables
        - "export NEXT_PUBLIC_API_URL=\"https://api.medh.co/api/v1\""
        - "export NEXT_PUBLIC_APP_ENV=\"production\""
        - "export JWT_SECRET=\"${JWT_SECRET:-fallback-jwt-secret}\""
        - "export API_KEY_SALT=\"${API_KEY_SALT:-fallback-salt}\""
        - "export SESSION_SECRET=\"${SESSION_SECRET:-fallback-session-secret}\""
        - "export MONGO_URI=\"${MONGO_URI}\""
        - "export NODE_OPTIONS='--max-old-space-size=8192'"
        - "export NEXT_TELEMETRY_DISABLED=1"
        - "export GENERATE_SOURCEMAP=false"
        - "export CI=true"
        - "export DISABLE_ESLINT_PLUGIN=true"
        # üîπ Automatic cache clear
        - "echo 'üîÑ Clearing previous build cache...'"
        - "rm -rf node_modules .next .next/cache .next/standalone || true"
        - "npm ci --legacy-peer-deps"
    build:
      commands:
        - "echo 'üèó Running Next.js production build (standalone output)'"
        - "npm run build"
        # Copy server folder and required-server-files.json to standalone root for Amplify
        - "cp -r .next/standalone/.next/server .next/standalone/server || true"
        - "cp .next/standalone/.next/required-server-files.json .next/standalone/"
        - "echo '‚úÖ Copied server files and required-server-files.json to standalone root'"
        # Remove memory-heavy binaries
        - "rm -f node_modules/@swc/core-linux-x64-gnu/swc.linux-x64-gnu.node || true"
        - "rm -f node_modules/@swc/core-linux-x64-musl/swc.linux-x64-musl.node || true"
        - "rm -f node_modules/@esbuild/linux-x64/bin/esbuild || true"
        - "echo '‚úÖ Build phase completed'"
  artifacts:
    baseDirectory: .next/standalone
    files:
      - "**/*"
  cache:
    paths:
      - "node_modules//*"
appRoot: .