version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "üîß Using Amplify default Node.js version (20.19.0)"
        - node --version
        - npm --version
        - export NEXT_TELEMETRY_DISABLED=1
        - export GENERATE_SOURCEMAP=false
        - export NODE_OPTIONS="--max-old-space-size=8192"
        - echo "üì¶ Installing dependencies using npm ci"
        - npm ci
    build:
      commands:
        - echo "üèó Running Next.js production build with standalone output"
        - npm run build
        # CRITICAL FIX 1: Copy required-server-files.json to standalone root
        - echo "üìã Copying required-server-files.json to standalone root"
        - cp .next/standalone/.next/required-server-files.json .next/standalone/required-server-files.json
        # CRITICAL FIX 2: Copy trace files to ALL possible locations
        - echo "üìã Creating all trace file locations for Amplify compatibility"
        - cp .next/trace .next/standalone/trace
        - mkdir -p .next/standalone/.next
        - cp .next/trace .next/standalone/.next/trace
        - mkdir -p .next/standalone/.next/server
        - cp .next/trace .next/standalone/.next/server/trace
        - mkdir -p .next/standalone/server
        - cp .next/trace .next/standalone/server/trace
        # Ensure minimal server directory (only trace) if checker expects it
        - echo "üìÅ Ensuring minimal server directory exists at baseDirectory root"
        - mkdir -p .next/standalone/server
        - cp .next/trace .next/standalone/server/trace
        - echo "‚úÖ Created minimal server/trace"
        # Ensure static assets are present inside standalone
        - mkdir -p .next/standalone/.next/static
        - cp -r .next/static/* .next/standalone/.next/static/ 2>/dev/null || true
        # Remove non-essential folders to reduce artifact size
        - rm -rf .next/standalone/src || true
        - rm -rf .next/standalone/public/fakedata || true
        # Remove duplicate traces to reduce artifact size (keep root + .next/server)
        - rm -f .next/standalone/.next/trace || true
        - echo "‚ôªÔ∏è Removed duplicate .next/trace"
        - echo "‚úÖ All trace files created in required locations"
        
        # Strip non-essential files to reduce artifact size
        - echo "‚ôªÔ∏è Stripping non-essential files to reduce artifact size"
        - rm -f .next/standalone/.env .next/standalone/.env.production || true
        - find .next/standalone -type f -name "*.map" -delete || true
        - find .next/standalone -type f \( -iname "*.md" -o -iname "README*" -o -iname "LICENSE*" -o -iname "CHANGELOG*" \) -delete || true
        - find .next/standalone/node_modules -type d -name "__tests__" -prune -exec rm -rf {} + || true
        - find .next/standalone/node_modules -type d -name "test" -prune -exec rm -rf {} + || true
        # Remove platform-specific binaries not used on Linux (saves tens of MB)
        - find .next/standalone/node_modules -type d -iname "*win32*" -prune -exec rm -rf {} + || true
        - find .next/standalone/node_modules -type d -iname "*darwin*" -prune -exec rm -rf {} + || true
        # Remove heavy Next build-only folders not needed at runtime
        - rm -rf .next/standalone/node_modules/next/dist/build || true
        - rm -rf .next/standalone/node_modules/next/dist/compiled/webpack || true
        - rm -rf .next/standalone/node_modules/next/dist/compiled/terser || true
        - rm -rf .next/standalone/node_modules/next/node_modules/@img || true
        # Remove sharp (image optimizer) since images.unoptimized=true
        - rm -rf .next/standalone/node_modules/sharp || true
        - rm -rf .next/standalone/node_modules/@img || true
        # Prune dev deps inside standalone package
        - cd .next/standalone && npm prune --omit=dev || true && cd -
        - echo "‚úÖ Size reduction tasks completed"
        - echo "üì¶ Standalone size (approx):" && du -sh .next/standalone || true
        - echo "üóÇ  Standalone/.next size (approx):" && du -sh .next/standalone/.next || true
        - echo "üéâ ALL FILES READY FOR AMPLIFY DEPLOYMENT!"
  artifacts:
    baseDirectory: .next/standalone
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.npm